---
title: "Results_SimpleGrid"
author: "Jennifer Blanc"
date: "2024-02-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(latex2exp)
library(ggpubr)
```

## Bias Plots

```{r, message=FALSE, warning=FALSE}
# Read in results 
df <- fread("../plots/SimpleGrid/A/q.txt")
df <- df [,3:ncol(df)]

# Average Bias and false positive rate 
dfPlot <- df %>% group_by(gwas_size, test_size, h2, num_causal, env, L, type, pheno, test) %>% summarize(count = n(), avg_q = mean(`nc-q`),lowerci_mean = avg_q - (1.96 * (sd(`nc-q`)  /  sqrt(n()))), upperci_mean = avg_q + (1.96 * (sd(`nc-q`)  /  sqrt(n()))), fp_strat = sum(`nc-p` < 0.05)/ n(), lowerci_fp = fp_strat - 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), upperci_fp = fp_strat + 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), q_std = avg_q / sd(`nc-q`))

# Order the types
dfPlot$type <- factor(dfPlot$type, levels = c("NoCorrection", "FGr", "10" , "ID"))

# Read in longitude results 
dfLong <- fread("../plots/SimpleGrid/A/q_long.txt")
dfLong <- dfLong[,3:ncol(dfLong)]

# Average Bias and false positive rate 
dfPlot_Long <- dfLong %>% group_by(gwas_size, test_size, h2, num_causal, env, L, type, pheno, test) %>% summarize(count = n(), avg_q = mean(`nc-q`),lowerci_mean = avg_q - (1.96 * (sd(`nc-q`)  /  sqrt(n()))), upperci_mean = avg_q + (1.96 * (sd(`nc-q`)  /  sqrt(n()))), fp_strat = sum(`nc-p` < 0.05)/ n(), lowerci_fp = fp_strat - 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), upperci_fp = fp_strat + 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), q_std = avg_q / sd(`nc-q`))
dfPlot_Long$test <- "Longitude"
dfPlot_Long$type <- factor(dfPlot_Long$type, levels = c("NoCorrection", "FGr", "10" , "ID"))

# Substitute names of tests 
dfPlot$test <- gsub("LAT", "Latitude", dfPlot$test)
dfPlot$test <- gsub("PS", "Single Deme", dfPlot$test)
```


```{r}
# Function to make bar plots with bias 
plot_bias <- function(df, pheno_type, test_type, env_type) {
  
  pl <- df %>% filter(pheno == pheno_type  & env == env_type & type != "ID") %>% filter(test %in% test_type ) %>% ggplot(aes(x = type, y = avg_q, fill = type)) + geom_col()+ geom_point(fill = "black", size = 3) + geom_hline(yintercept = 0, color = "red") + geom_errorbar(aes(ymin = lowerci_mean, ymax = upperci_mean), width = 0.2) +
  theme_classic(base_size = 12) + theme(panel.border = element_rect(colour = "black", fill=NA, size=1), axis.text.x = element_text(size = 8, color = "black",  angle = 35, hjust=1), legend.position = "none", legend.text.align = 0) + 
  scale_fill_manual(values = c("goldenrod2","navy", "red4")) + scale_x_discrete(labels = unname(TeX(c("Uncorrected", "$\\hat{F}_{Gr}$", "10 PCs")))) + xlab("") + ylab("Bias") + facet_wrap(~test)
  
  return(pl)
}

# Plot bias 
plLL <- plot_bias(dfPlot,"LAT", "Latitude", 0.2)
plDL <- plot_bias(rbind(dfPlot, dfPlot_Long), "DIAG", c("Latitude", "Longitude"), 0.2)
plPS <- plot_bias(dfPlot,"PS", "Single Deme", 0.2)
```

## PRS Plots

```{r}

plot_PRS <- function(dfNC, dfFGr, dfPCs, ll, up) {
  
  # No Correction
  plNC <- ggplot(data =dfNC, aes(x = LONG, y = LAT, fill = avg_PRS)) + geom_tile() +  theme_classic(base_size = 12) +  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + scale_fill_gradient2(low = "brown4", high = "royalblue4", name = "PGS", limits = c(ll, up)) + xlab("Longitude") + ylab("Latitude") + scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(0,6,1)) + theme(axis.title = element_blank())
  
  # FGr included
  plFGr <- ggplot(data =dfFGr, aes(x = LONG, y = LAT, fill = avg_PRS)) + geom_tile() +  theme_classic(base_size = 12) +  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + scale_fill_gradient2(low = "brown4", high = "royalblue4", name = "PGS", limits = c(ll, up)) + xlab("Longitude") + ylab("Latitude") + scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(0,6,1)) + theme(axis.title = element_blank())
  
  # 10 PCs included
  plPCs <- ggplot(data =dfPCs, aes(x = LONG, y = LAT, fill = avg_PRS)) + geom_tile() +  theme_classic(base_size = 12) +  theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + scale_fill_gradient2(low = "brown4", high = "royalblue4", name = "PGS", limits = c(ll, up)) + xlab("Longitude") + ylab("Latitude") + scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(0,6,1)) + theme(axis.title = element_blank())
  
  # Combine plots
  pl <- ggpubr::ggarrange(plNC, plFGr, plPCs, common.legend = T, legend="right", nrow = 1)
  
}

# Lat/Lat
dfNC <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/LAT/LAT/prs-NoCorrection_L-20000.txt")
dfFGr <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/LAT/LAT/prs-FGr_L-20000.txt")
dfPCs <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/LAT/LAT/prs-10_L-20000.txt")
prsLL <- plot_PRS(dfNC, dfFGr, dfPCs, -.6, .6)


# Diag/Lat
dfNC <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/DIAG/LAT/prs-NoCorrection_L-20000.txt")
dfFGr <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/DIAG/LAT/prs-FGr_L-20000.txt")
dfPCs <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/DIAG/LAT/prs-10_L-20000.txt")
prsDL <- plot_PRS(dfNC, dfFGr, dfPCs, -.2, .4)

# PS/PS
dfNC <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/PS/PS/prs-NoCorrection_L-20000.txt")
dfFGr <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/PS/PS/prs-FGr_L-20000.txt")
dfPCs <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/PS/PS/prs-10_L-20000.txt")
prsPS <- plot_PRS(dfNC, dfFGr, dfPCs, -.2, .2)
```

## Phenotype Plots 

```{r}
# Function to plot phenotype grid
plot_pheno <- function(df) {
  
  pl <- ggplot(df, aes(x = LONG, y = LAT, fill = avg_PRS)) + geom_tile() + theme_classic(base_size = 12) +  theme(panel.border = element_rect(colour = "black", fill=NA, size=1), legend.position = "none") + scale_fill_gradient2(low = "palegoldenrod", high = "purple4") + xlab("Longitude") + ylab("Latitude") + scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(0,6,1)) + theme(axis.title = element_blank())
  
  return(pl)
}

# Lat
df <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/LAT/phenos_L-20000.txt")
phenoLat <- plot_pheno(df)

# Diag
df <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/DIAG/phenos_L-20000.txt")
phenoDiag <- plot_pheno(df)


# PS 
df <- fread("../plots/SimpleGrid/gp-2160/tp-720/h2-0.0/c-300/env_0.2/PS/phenos_L-20000.txt")
phenoPS <- plot_pheno(df)
```

## Final Figure 4
```{r}
sv1 <- ggpubr::ggarrange(phenoLat, prsLL, plLL, nrow = 1, widths = c(0.19, 0.61, 0.2))
sv2 <- ggpubr::ggarrange(phenoDiag, prsDL, plDL, nrow = 1, widths = c(0.19, 0.61, 0.2))
sv3 <- ggpubr::ggarrange(phenoPS, prsPS, plPS, nrow = 1, widths = c(0.19, 0.61, 0.2))

out <- ggarrange(sv1, sv2, sv3, nrow = 4, ncol = 1)
ggsave("~/Desktop/fig4.png", out, height = 10, width = 12)
```

## Variance Explained Plots 

#### Confounder

```{r}
make_confounder_plot <- function(df, lab_title) {
  
  pl  <- ggplot(data = df, aes(x = PC, y = avg_r2)) + geom_bar(stat = "identity", fill = "purple4", aes( alpha = color)) + ylab(TeX("$R^2$")) + xlab("Cumulative PCs") + theme_classic(base_size = 14) + ylim(0,1)+ scale_alpha_manual(values = c(0.25, 1), guide="none") + geom_hline(yintercept = 1, color = "red", linetype = "longdash", size = 1.5) +theme( plot.title=element_text(hjust = 0.9,vjust=-40, face='bold', size = 12)) + ggtitle(lab_title)
  #+ geom_point(size = 1, aes( alpha = color)) 
  
  return(pl)
}

make_FGr_plot <- function(df, lab_title) {
  
  pl  <- ggplot(data = df, aes(x = PC, y = avg_r2)) + geom_bar(stat = "identity", fill = "navy", aes( alpha = color)) + ylab(TeX("$R^2$")) + xlab("Cumulative PCs") + theme_classic(base_size = 14) + ylim(0,1)+ scale_alpha_manual(values = c(0.25, 1), guide="none") + geom_hline(yintercept = 1, color = "red", linetype = "longdash", size = 1.5) +theme( plot.title=element_text(hjust = 0.9,vjust=-40, face='bold', size = 12)) + ggtitle(lab_title)
  #+ geom_point(size = 1, aes( alpha = color)) 
  
  return(pl)
}
```



```{r}
dfLat <- fread("../plots/SimpleGrid/A/gp-2160/tp-720/h2-0.0/c-300/env_0.2/LAT/confounder_varEx-L-20000.txt")[,2:6]
colnames(dfLat)[1] <- "PC"
dfLat$color <-c(rep("TRUE", 10), rep("FALSE", 2149))

dfDiag <- fread("../plots/SimpleGrid/A/gp-2160/tp-720/h2-0.0/c-300/env_0.2/Diag/confounder_varEx-L-20000.txt")[,2:6]
colnames(dfDiag)[1] <- "PC"
dfDiag$color <-c(rep("TRUE", 10), rep("FALSE", 2149))

dfPS <- fread("../plots/SimpleGrid/A/gp-2160/tp-720/h2-0.0/c-300/env_0.2/PS/confounder_varEx-L-20000.txt")[,2:6]
colnames(dfPS)[1] <- "PC"
dfPS$color <-c(rep("TRUE", 10), rep("FALSE", 2149))

cLat <- make_confounder_plot(dfLat, "Latitude")
cDiag <- make_confounder_plot(dfDiag, "Diagonal")
cPS <- make_confounder_plot(dfPS, "Single Deme")
```


```{r}
dfLat <- fread("../plots/SimpleGrid/A/gp-2160/tp-720/h2-0.0/c-300/LAT/FGr_varEx-L-20000.txt")[,2:6]
colnames(dfLat)[1] <- "PC"
dfLat$color <-c(rep("TRUE", 10), rep("FALSE", 2149))

dfPS <- fread("../plots/SimpleGrid/A/gp-2160/tp-720/h2-0.0/c-300/PS/FGr_varEx-L-20000.txt")[,2:6]
colnames(dfPS)[1] <- "PC"
dfPS$color <-c(rep("TRUE", 10), rep("FALSE", 2149))

fLat <- make_FGr_plot(dfLat, "Latitude")
fPS <- make_FGr_plot(dfPS, "Single Deme")
```

```{r}
pl <- ggarrange(cLat,  fLat, cDiag, fLat, cPS, fPS, ncol=2, nrow =3)
ggsave("~/Desktop/fig5.png", pl, height = 8)
```

## Supplemental Figures 

```{r}
df <- fread("../plots/SimpleGrid/A/q_PCs.txt")[,3:19]

# Average Bias and false positive rate 
dfPlot <- df %>% group_by(gwas_size, test_size, h2, num_causal, env, L, type, pheno, test) %>% summarize(count = n(), avg_q = mean(`nc-q`),lowerci_mean = avg_q - (1.96 * (sd(`nc-q`)  /  sqrt(n()))), upperci_mean = avg_q + (1.96 * (sd(`nc-q`)  /  sqrt(n()))), fp_strat = sum(`nc-p` < 0.05)/ n(), lowerci_fp = fp_strat - 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), upperci_fp = fp_strat + 1.96 * sqrt((fp_strat * (1-fp_strat))/ n()), q_std = avg_q / sd(`nc-q`)) %>% filter(pheno == "LAT" & test == "LAT")

```



